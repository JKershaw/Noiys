var path = './test_gs_working_field_read.tmp'; // Test file path (approx 2MB)

////

var mongodb = require('./lib/mongodb');
var fs = require('fs');

var mongodbClient = new mongodb.Db('test', new mongodb.Server('127.0.0.1', 27017, {}), { w: 1 });

var writeFile = function (path, sample, cb) {
    var name = 'file' + new mongodb.ObjectID().toString();
    var gs = new mongodb.GridStore(mongodbClient, name, 'w');
    gs.open(function (err, gs) {
        if (err) throw err;
        console.log('start writing ' + sample);
        var stdout = fs.createReadStream(path);
        stdout.on('close', function () {
            console.log('finish writing ' + sample);
            gs.close(function () {
                cb(null, name);
            });
        });
        stdout.pipe(gs);
    });
};

mongodbClient.open(function (err) {
    if (!err) {
        for (var i = 0; i < 10; i++) {
            writeFile(path, i, function (err, name) {
                console.log(name);
            });

            writeFile(path, i, function (err, name) {
                console.log(name);
            });

            writeFile(path, i, function (err, name) {
                console.log(name);
            });
        }
    }
});