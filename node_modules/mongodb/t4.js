var format = require('util').format
  , MongoClient = require("./lib/mongodb").MongoClient
  , ReplicaSetManager = require("./test/tools/replica_set_manager").ReplicaSetManager;

// var url = format("mongodb://%s,%s,%s/%s?replicaSet=%s&readPreference=%s&autoReconnect=%s&connectTimeoutMS=%d"
//   ,  "localhost:30010"
//   ,  "localhost:30011"
//   ,  "localhost:30012"
//   ,  "foo"
//   ,  "replica-set-foo"
//   ,  "secondary"
//   ,  "true"
//   ,  "1500");

var url = format("mongodb://%s,%s,%s/%s?replicaSet=%s&readPreference=%s&autoReconnect=%s&connectTimeoutMS=%d"
  ,  "localhost:30010"
  ,  "localhost:30011"
  ,  "localhost:30012"
  ,  "foo"
  ,  "replica-set-foo"
  ,  "secondary"
  ,  "true"
  ,  "1500");

// Setting up replicaset options
var repl_options = { 
    retries:120, secondary_count:2
  , passive_count:0, arbiter_count:1
  , start_port: 30010
  , tags:[{"dc1":"ny"}, {"dc1":"ny"}, {"dc2":"sf"}]
  , fullLogging:true
}

// // Set up replicaset manager
// var replicasetManager = new ReplicaSetManager(repl_options);
// replicasetManager.startSet(true, function(err, result) {
  
  MongoClient.connect(url, function(err, db){
     if (!err) { 
       console.log("Connected to replset");

       // NOTE: This goes to primary
       db.command({dbStats:1}, function(err, res){
           if (!err) {
               console.log(res);               
           }

           db.close();
       });

       // NOTE: This *also* goes to primary
       // db.stats({readPreference: Server.SECONDARY},function(err, stats){
       //     if (!err) {
       //         console.log(stats);
       //     }
       //     db.close();
       // });

       // NOTE: Queries seem to honor readPreference i.e. this goes to secondary
       // db.collection('things').find({a:{"$in":[1,2,3]}}).toArray(function(err, res){
       //     if (!err) {
       //         console.log(res);
       //     }
       //     db.close();
       // });       

     } 
  });
// });